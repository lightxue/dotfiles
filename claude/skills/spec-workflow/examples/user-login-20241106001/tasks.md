# 用户登录功能 - 任务规划

> 文档路径：.specs/user-login-20241106001/tasks.md
> 创建时间：2024-11-06
> 需求来源：【用户登录功能实现】文字需求描述
> 关联设计：.specs/user-login-20241106001/design.md

## 任务约定

- 最小单元：10-15 分钟
- 状态：todo / doing / done
- 执行模式：分组执行 → 确认 → 下一分组
- 严格按 design.md 执行

## 分组执行计划

### 分组 1：基础设施准备（45分钟）

**执行顺序**：第 1 组
**依赖**：无
**预计时间**：45分钟

- [ ] T1 创建数据库表

  - 描述：创建users表和相关索引
  - 设计参考：design.md - 数据模型
  - 文件操作：新增 migrations/001_create_users_table.sql
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 1
  - 产出：users表创建SQL、索引创建SQL

- [ ] T2 添加JWT配置

  - 描述：在配置文件中添加JWT相关配置项
  - 设计参考：design.md - JWT密钥管理
  - 文件操作：修改 config/config.go, config/config.yaml
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 1
  - 产出：JWT配置结构体定义

- [ ] T3 实现密码加密工具

  - 描述：实现密码哈希和验证函数
  - 设计参考：design.md - 密码安全存储
  - 文件操作：新增 utils/password_util.go, utils/password_util_test.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 1
  - 产出：HashPassword和VerifyPassword函数

- [ ] T4 实现JWT工具函数

  - 描述：实现JWT生成和验证
  - 设计参考：design.md - JWT Payload结构
  - 文件操作：新增 utils/jwt_util.go, utils/jwt_util_test.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 1
  - 产出：GenerateJWT和ValidateJWT函数

### 分组 2：数据层实现（40分钟）

**执行顺序**：第 2 组
**依赖**：分组 1 完成
**预计时间**：40分钟

- [ ] T5 定义User模型

  - 描述：创建User数据模型结构
  - 设计参考：design.md - 数据模型
  - 文件操作：新增 model/user.go
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 2
  - 产出：User结构体定义

- [ ] T6 实现UserRepo

  - 描述：实现用户数据访问层
  - 设计参考：design.md - 改动分析
  - 文件操作：新增 repo/user_repo.go, repo/user_repo_test.go
  - 预计用时：20m
  - 状态：todo
  - 分组：分组 2
  - 产出：GetUserByUsername和CreateUser函数

- [ ] T7 实现Redis登录状态管理

  - 描述：实现登录失败次数和账户锁定管理
  - 设计参考：design.md - 登录失败次数限制
  - 文件操作：新增 repo/login_state_repo.go, repo/login_state_repo_test.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 2
  - 产出：IncrementFailedCount、IsAccountLocked、ResetFailedCount函数

### 分组 3：业务逻辑层（50分钟）

**执行顺序**：第 3 组
**依赖**：分组 2 完成
**预计时间**：50分钟

- [ ] T8 实现LoginService结构

  - 描述：创建登录服务基础结构
  - 设计参考：design.md - 整体架构
  - 文件操作：新增 service/login_service.go
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 3
  - 产出：LoginService结构体定义

- [ ] T9 实现登录业务逻辑

  - 描述：实现完整的登录流程
  - 设计参考：design.md - 接口与数据
  - 文件操作：修改 service/login_service.go
  - 预计用时：25m
  - 状态：todo
  - 分组：分组 3
  - 产出：Login方法实现

- [ ] T10 实现登录失败处理

  - 描述：处理登录失败的计数和锁定逻辑
  - 设计参考：design.md - 登录失败次数限制
  - 文件操作：修改 service/login_service.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 3
  - 产出：失败次数自增、账户锁定逻辑

- [ ] T11 添加LoginService单元测试

  - 描述：编写登录服务的单元测试
  - 设计参考：design.md - 测试策略
  - 文件操作：新增 service/login_service_test.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 3
  - 产出：登录成功/失败/锁定场景测试用例

### 分组 4：API接口层（35分钟）

**执行顺序**：第 4 组
**依赖**：分组 3 完成
**预计时间**：35分钟

- [ ] T12 实现登录接口

  - 描述：实现HTTP登录接口
  - 设计参考：design.md - 接口与数据
  - 文件操作：新增 api/login_api.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 4
  - 产出：Login接口处理函数

- [ ] T13 实现JWT认证中间件

  - 描述：实现JWT令牌验证中间件
  - 设计参考：design.md - 改动分析
  - 文件操作：新增 middleware/auth_middleware.go, middleware/auth_middleware_test.go
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 4
  - 产出：AuthMiddleware中间件函数

- [ ] T14 注册路由

  - 描述：在路由中注册登录接口
  - 设计参考：design.md - 接口与数据
  - 文件操作：修改 router/router.go
  - 预计用时：5m
  - 状态：todo
  - 分组：分组 4
  - 产出：POST /api/v1/login路由注册

### 分组 5：测试和文档（25分钟）

**执行顺序**：第 5 组
**依赖**：分组 4 完成
**预计时间**：25分钟

- [ ] T15 集成测试

  - 描述：编写完整的集成测试
  - 设计参考：design.md - 测试策略
  - 文件操作：新增 test/integration/login_test.go
  - 预计用时：20m
  - 状态：todo
  - 分组：分组 5
  - 产出：正常登录/失败锁定/并发登录测试用例

- [ ] T16 代码审查清单

  - 描述：自审代码质量
  - 设计参考：design.md - 全文
  - 文件操作：无（代码审查）
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 5
  - 产出：代码规范/安全性/性能检查清单

### 分组 6：文档更新与验证（30分钟）

**执行顺序**：第 6 组
**依赖**：分组 5 完成
**预计时间**：30分钟

- [ ] T17 更新项目wiki文档

  - 描述：根据本次需求变更更新 doc/iwiki.md，反映所有变更内容
  - 设计参考：design.md - 全部章节
  - 更新内容：接口文档、请求/响应示例、错误码说明、架构调整、数据模型、配置变更、新增依赖
  - 文件操作：修改 doc/iwiki.md
  - 预计用时：20m
  - 状态：todo
  - 分组：分组 6
  - 模板参考：assets/templates/iwiki.md.template
  - 质量要求：标注更新时间（2024-11-06）、需求来源（用户登录功能）、保持结构完整、与代码一致、代码位置标注

- [ ] T18 验证wiki文档完整性

  - 描述：使用 spec-workflow skill 运行验证脚本，确保wiki文档通过所有检查
  - 设计参考：N/A（流程验证任务）
  - 文件操作：无（仅验证）
  - 执行方式：`use_skill("spec-workflow")` 验证wiki文档
  - 验证命令：`python3 <SKILL_DIR>/scripts/validate_wiki.py doc/iwiki.md`
  - 验证内容：接口全量性、mermaid图、代码位置标注、内容完整性
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 6
  - ⚠️ 必须通过（exit code = 0）才能完成本分组

### 分组 7：最终验收与审批（35分钟）

**执行顺序**：第 7 组
**依赖**：分组 6 完成
**预计时间**：35分钟

- [ ] T19 验证任务完成状态

  - 描述：使用 spec-workflow skill 验证所有任务已完成，验收清单全部勾选
  - 设计参考：N/A（流程验证任务）
  - 文件操作：无（仅验证）
  - 验证命令：`python3 <SKILL_DIR>/scripts/validate_tasks.py .specs/user-login-20241106001/tasks.md --phase execution`
  - 预计用时：5m
  - 状态：todo
  - 分组：分组 7
  - ⚠️ 必须通过（exit code = 0）才能继续

- [ ] T20 最终质量检查

  - 描述：执行最终质量检查清单，确保所有CRITICAL项通过
  - 设计参考：N/A（质量检查任务）
  - 文件操作：无（检查任务）
  - 检查项目：**CRITICAL**（单元测试覆盖率≥80%、回归测试通过、性能测试通过）、**IMPORTANT**（集成测试通过、安全性检查通过）
  - 预计用时：15m
  - 状态：todo
  - 分组：分组 7
  - ⚠️ CRITICAL项必须通过，否则禁止完成阶段3

- [ ] T21 生成执行总结文档

  - 描述：基于模板生成 execution_summary.md，记录执行概况、代码变更、质量检查报告
  - 设计参考：N/A（文档生成任务）
  - 文件操作：新增 .specs/user-login-20241106001/execution_summary.md
  - 模板路径：assets/templates/execution_summary.md.template
  - 输出路径：.specs/user-login-20241106001/execution_summary.md
  - 核心内容：执行概况、代码变更总结、质量检查报告、Wiki更新确认、需求验收确认、遗留问题与优化建议
  - 预计用时：10m
  - 状态：todo
  - 分组：分组 7

- [ ] T22 等待人工审批

  - 描述：等待用户审批，使用有效审批用语执行审批命令
  - 设计参考：N/A（审批流程任务）
  - 文件操作：无（人工审批）
  - 审批命令：`python3 <SKILL_DIR>/scripts/phase_gateway.py --approve-phase 3 --approval "<当前对话用户回复的审批原文>" --approver "<当前对话的用户名称>"`
  - 有效用语：`审批通过` `确认无误` `同意` `批准` `可以` `没问题`
  - 预计用时：5m
  - 状态：todo
  - 分组：分组 7
  - ⚠️ 必须使用有效审批用语，审批通过后工作流完成

## 分组依赖关系

```mermaid
graph LR
    G1[分组1: 基础设施准备] --> G2[分组2: 数据层实现]
    G2 --> G3[分组3: 业务逻辑层]
    G3 --> G4[分组4: API接口层]
    G4 --> G5[分组5: 测试和文档]
    G5 --> G6[分组6: 文档更新与验证]
    G6 --> G7[分组7: 最终验收与审批]
```

## 分组执行状态

- [ ] 分组 1：基础设施准备 - 状态：待执行
- [ ] 分组 2：数据层实现 - 状态：待执行
- [ ] 分组 3：业务逻辑层 - 状态：待执行
- [ ] 分组 4：API接口层 - 状态：待执行
- [ ] 分组 5：测试和文档 - 状态：待执行
- [ ] 分组 6：文档更新与验证 - 状态：待执行
- [ ] 分组 7：最终验收与审批 - 状态：待执行

## 验收清单

### 功能验收

- [ ] 所有分组执行完成并确认
- [ ] 所有任务状态为 done
- [ ] 需求的所有功能点已实现
- [ ] 需求的验收标准已满足

**需求验收标准**（基于design.md）：
- [ ] 用户可以使用正确的用户名密码登录
- [ ] 登录成功后返回JWT令牌
- [ ] 错误的用户名或密码返回明确的错误提示
- [ ] 连续5次登录失败后锁定账户15分钟
- [ ] JWT令牌有效期为24小时
- [ ] 所有敏感信息（密码）必须加密存储

### 质量验收

- [ ] 代码审查通过
- [ ] 单元测试覆盖率 ≥80%
- [ ] 回归测试通过
- [ ] 性能测试通过（登录接口P99 < 200ms）

**代码质量**：
- [ ] 代码符合项目规范
- [ ] 函数命名清晰，见名知意
- [ ] 关键逻辑有中文注释
- [ ] 无明显代码坏味道

**安全性**：
- [ ] 密码使用bcrypt加密
- [ ] JWT密钥从环境变量读取
- [ ] 无敏感信息硬编码
- [ ] 输入参数严格验证

**性能**：
- [ ] 数据库查询有索引
- [ ] Redis操作使用合理TTL

### 文档验收

- [ ] 接口文档已更新
- [ ] wiki 文档已同步
- [ ] 代码注释完整

### 部署验收

- [ ] 灰度发布方案已制定
- [ ] 监控告警已配置
- [ ] 回滚方案已验证

## 执行日志

### 分组 1 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T1, T2, T3, T4
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 2 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T5, T6, T7
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 3 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T8, T9, T10, T11
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 4 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T12, T13, T14
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 5 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T15, T16
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 6 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T17, T18
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

### 分组 7 执行记录

**执行时间**：待执行
**执行人**：待分配
**完成任务**：T19, T20, T21, T22
**遇到问题**：无
**解决方案**：无
**用户确认**：待确认

## 附录

### 技术债务

| 编号 | 描述 | 影响 | 优先级 | 计划处理时间 |
|------|------|------|--------|-------------|
| 暂无 | - | - | - | - |

### 改进建议

- 后续可考虑添加验证码功能
- 后续可考虑实现refresh_token机制
- 后续可考虑支持第三方登录（微信、企业微信）

### 变更记录

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 2024-11-06 | 1.0 | 初始版本 | 开发团队 |
