# {é¡¹ç›®åç§°} - å®ç°ç»†èŠ‚æ–‡æ¡£

> å…³è”æ–‡æ¡£ï¼š[README](README.md) | [æ¶æ„è®¾è®¡](architecture.md) | [æ¥å£æ–‡æ¡£](interfaces.md)

## 1. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

**è¯´æ˜**ï¼šæœ¬ç« èŠ‚ä»…ä¸º2-3ä¸ªæ ¸å¿ƒä¸šåŠ¡æµç¨‹ç»˜åˆ¶æµç¨‹å›¾ï¼Œé¿å…æ–‡æ¡£è†¨èƒ€ã€‚

### 1.1 ç”¨æˆ·è®¤è¯æµç¨‹

**åœºæ™¯**ï¼šå®Œæ•´çš„ç™»å½•è®¤è¯æµç¨‹ï¼ˆé˜²æš´åŠ›ç ´è§£ + å¯†ç éªŒè¯ + JWTç”Ÿæˆï¼‰

#### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client
    participant API
    participant Service
    participant Cache as Redis
    participant DB as MySQL

    Client->>API: POST /api/v1/login
    Note over API: å‚æ•°éªŒè¯ (api/login_api.go:15)
    
    API->>Service: Login(username, password)
    Service->>Cache: æ£€æŸ¥é”å®šçŠ¶æ€
    Note over Cache: GET login:locked:{username}
    
    alt è´¦æˆ·å·²é”å®š
        Cache-->>Client: 403 è´¦æˆ·å·²é”å®š
    else æœªé”å®š
        Service->>DB: æŸ¥è¯¢ç”¨æˆ·
        Note over DB: repo/user_repo.go:15-25
        
        alt ç”¨æˆ·ä¸å­˜åœ¨
            Service->>Cache: INCRå¤±è´¥è®¡æ•°
            Service-->>Client: 401 å¯†ç é”™è¯¯
        else ç”¨æˆ·å­˜åœ¨
            Service->>Service: bcryptéªŒè¯å¯†ç 
            Note over Service: auth_service.go:50-60
            
            alt å¯†ç é”™è¯¯
                Service->>Cache: INCRå¤±è´¥è®¡æ•°
                alt å¤±è´¥â‰¥5æ¬¡
                    Service->>Cache: SETé”å®šæ ‡è®°(15min)
                    Service-->>Client: 403 è´¦æˆ·é”å®š
                else å¤±è´¥<5æ¬¡
                    Service-->>Client: 401 å¯†ç é”™è¯¯
                end
            else å¯†ç æ­£ç¡®
                Service->>Cache: DELå¤±è´¥è®¡æ•°
                Service->>Service: ç”ŸæˆJWT
                Note over Service: jwt_util.go:20-40
                Service-->>Client: 200 è¿”å›token
            end
        end
    end
```

#### æ ¸å¿ƒæ­¥éª¤

| æ­¥éª¤ | ä»£ç ä½ç½® | å…³é”®é€»è¾‘ | è¯´æ˜ |
|------|---------|---------|------|
| 1. é”å®šæ£€æŸ¥ | `service/auth_service.go:30-40` | Redis GET `login:locked:{username}` | Redisæ•…éšœæ—¶é™çº§è·³è¿‡ |
| 2. æŸ¥è¯¢ç”¨æˆ· | `repo/user_repo.go:15-25` | SQL: `SELECT ... WHERE username=?` | ä½¿ç”¨`idx_username`ç´¢å¼• |
| 3. éªŒè¯å¯†ç  | `service/auth_service.go:50-60` | bcrypt.CompareHashAndPassword | è€—æ—¶50-100ms |
| 4. å¤±è´¥ç®¡ç† | `service/auth_service.go:70-90` | Redis INCR + æ¡ä»¶é”å®š | 5æ¬¡å¤±è´¥é”15åˆ†é’Ÿ |
| 5. ç”ŸæˆJWT | `utils/jwt_util.go:20-40` | HS256ç­¾åï¼Œ24hè¿‡æœŸ | å¯†é’¥æ¥è‡ªç¯å¢ƒå˜é‡ |

---

### 1.2 ç¼“å­˜æ›´æ–°æµç¨‹ï¼ˆCache-Asideæ¨¡å¼ï¼‰

**åœºæ™¯**ï¼šè¯»ç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥DBå¹¶å›å†™ï¼Œå†™æ“ä½œæ—¶åˆ é™¤ç¼“å­˜ã€‚

#### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client
    participant Service
    participant Cache as Redis
    participant DB as MySQL

    Note over Client,DB: è¯»æ“ä½œ
    Client->>Service: GetUserByID(123)
    Service->>Cache: GET user:123
    
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>Service: è¿”å›æ•°æ®
        Service-->>Client: 200 OK
    else ç¼“å­˜æœªå‘½ä¸­
        Service->>DB: SELECT * WHERE id=123
        Note over DB: repo/user_repo.go:65-70
        DB-->>Service: è¿”å›æ•°æ®
        Service->>Cache: SETEX user:123 3600 <data>
        Service-->>Client: 200 OK
    end
    
    Note over Client,DB: å†™æ“ä½œ
    Client->>Service: UpdateUser(user)
    Service->>DB: UPDATE users SET ...
    Note over DB: repo/user_repo.go:95-98
    Service->>Cache: DEL user:123
    Note over Cache: repo/user_repo.go:102
    Service-->>Client: 200 OK
```

#### æ ¸å¿ƒå®ç°

| æ“ä½œ | ä»£ç ä½ç½® | å…³é”®é€»è¾‘ |
|------|---------|---------|
| è¯»å– | `repo/user_repo.go:50-80` | æŸ¥ç¼“å­˜ â†’ æœªå‘½ä¸­æŸ¥DB â†’ å†™ç¼“å­˜(TTL=1h) |
| æ›´æ–° | `repo/user_repo.go:90-110` | æ›´æ–°DB â†’ åˆ é™¤ç¼“å­˜ |
| åˆ é™¤ | `repo/user_repo.go:120-135` | è½¯åˆ é™¤DB â†’ åˆ é™¤ç¼“å­˜ |

**ç¼“å­˜ç©¿é€é˜²æŠ¤**ï¼šç©ºç»“æœç¼“å­˜5åˆ†é’Ÿï¼Œå¯é€‰å¸ƒéš†è¿‡æ»¤å™¨

---

## 2. å…³é”®å®ç°ç‚¹

### 2.1 JWTä»¤ç‰Œç®¡ç†

| æ“ä½œ | ä»£ç ä½ç½® | è¯´æ˜ |
|------|---------|------|
| ç”Ÿæˆä»¤ç‰Œ | `utils/jwt_util.go:20-40` | HS256ç­¾åï¼Œ24hè¿‡æœŸï¼Œå¯†é’¥æ¥è‡ªç¯å¢ƒå˜é‡`JWT_SECRET` |
| éªŒè¯ä»¤ç‰Œ | `middleware/auth.go:15-40` | æå–token â†’ éªŒè¯ç­¾å â†’ è§£æclaims â†’ æ³¨å…¥ä¸Šä¸‹æ–‡ |
| Payloadç»“æ„ | `utils/jwt_util.go:10` | `{user_id, username, exp, iat}` |

---

### 2.2 å¯†ç åŠ å¯†

| åœºæ™¯ | ä»£ç ä½ç½® | ç®—æ³• | è€—æ—¶ |
|------|---------|------|------|
| æ³¨å†Œæ—¶åŠ å¯† | `utils/password_util.go:10-20` | bcrypt (cost=10) | 100-150ms |
| ç™»å½•æ—¶éªŒè¯ | `utils/password_util.go:25-35` | bcrypt.Compare | 50-100ms |

---

### 2.3 æ•°æ®åº“ä¼˜åŒ–

**å…³é”®ç´¢å¼•**ï¼š
- `users.idx_username` (UNIQUE) - ç™»å½•æŸ¥è¯¢ä¼˜åŒ–
- `users.idx_status` - çŠ¶æ€ç­›é€‰

**æ‰¹é‡æŸ¥è¯¢**ï¼š
- **ä½ç½®**ï¼š`repo/user_repo.go:120-140`
- **ä¼˜åŒ–**ï¼šä½¿ç”¨INæŸ¥è¯¢é¿å…N+1é—®é¢˜

**äº‹åŠ¡å¤„ç†**ï¼š
- **ä½ç½®**ï¼š`service/user_service.go:100-130`
- **ç‰¹æ€§**ï¼šè‡ªåŠ¨å›æ»šã€åµŒå¥—äº‹åŠ¡æ”¯æŒ

---

### 2.4 é”™è¯¯å¤„ç†

| ç»„ä»¶ | ä»£ç ä½ç½® | åŠŸèƒ½ |
|------|---------|------|
| é”™è¯¯å®šä¹‰ | `pkg/errors/errors.go:10-30` | 40001-40099å®¢æˆ·ç«¯é”™è¯¯ï¼Œ50001-50099æœåŠ¡ç«¯é”™è¯¯ |
| é”™è¯¯ä¸­é—´ä»¶ | `middleware/error_handler.go:10-40` | è‡ªåŠ¨æ•è·ã€ç»Ÿä¸€å“åº”æ ¼å¼ã€HTTPçŠ¶æ€ç æ˜ å°„ |

---

**ğŸ“– å®Œæ•´æ–‡æ¡£**ï¼šæŸ¥çœ‹ [README](README.md) äº†è§£é¡¹ç›®æ¦‚è§ˆ
